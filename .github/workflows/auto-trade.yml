name: Auto Trade

on:
  schedule:
    # Run every 30 minutes during market hours (9:30 AM - 4:00 PM ET)
    # Covers both EST (UTC-5) and EDT (UTC-4) timezones
    # Format: minute hour day-of-month month day-of-week
    # Runs at :00 and :30 of each hour from 13:00 to 21:00 UTC (Mon-Fri)
    - cron: '0,30 13-20 * * 1-5'
  workflow_dispatch: # Allows manual triggering

jobs:
  auto-trade:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Trade symbols
        env:
          APP_URL: ${{ secrets.APP_URL }}
          AUTO_TRADE_SECRET: ${{ secrets.AUTO_TRADE_SECRET }}
          TRADING_SYMBOLS: ${{ secrets.TRADING_SYMBOLS }}
        run: |
          # If TRADING_SYMBOLS is set, trade each symbol
          # Otherwise, default to SPY
          if [ -z "$TRADING_SYMBOLS" ]; then
            SYMBOLS="SPY"
          else
            SYMBOLS="$TRADING_SYMBOLS"
          fi
          
          # Split comma-separated symbols and trade each one
          IFS=',' read -ra SYMBOL_ARRAY <<< "$SYMBOLS"
          for symbol in "${SYMBOL_ARRAY[@]}"; do
            symbol=$(echo "$symbol" | xargs) # Trim whitespace
            echo "ðŸ”„ Trading symbol: $symbol"
            
            response=$(curl -s -L -w "\n%{http_code}" -X POST "$APP_URL/api/strategy/auto" \
              -H "Content-Type: application/json" \
              -H "x-api-secret: $AUTO_TRADE_SECRET" \
              -d "{\"symbol\": \"$symbol\", \"autoExecute\": true}")
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')
            
            if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
              echo "âœ… Successfully traded $symbol"
              echo "$body" | jq '.' || echo "$body"
            else
              echo "âŒ Failed to trade $symbol (HTTP $http_code)"
              echo "$body"
            fi
            
            echo "---"
          done
