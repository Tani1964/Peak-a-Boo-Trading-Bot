name: Auto Trade

on:
  schedule:
    # Run every weekday at 9:30 AM ET (14:30 UTC, market open time)
    # Note: GitHub Actions uses UTC time
    # 9:30 AM ET = 14:30 UTC (during EST) or 13:30 UTC (during EDT)
    # Using 13:30 UTC to cover EDT (Eastern Daylight Time)
    - cron: '30 13 * * 1-5'  # Mon-Fri at 13:30 UTC (9:30 AM EDT / 8:30 AM EST)
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      symbols:
        description: 'Comma-separated stock symbols (e.g., SPY,QQQ,AAPL) or leave empty to use TRADING_SYMBOLS secret'
        required: false
        default: ''

jobs:
  trade:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Auto Trade
        env:
          APP_URL: ${{ secrets.APP_URL }}
          API_SECRET: ${{ secrets.AUTO_TRADE_SECRET }}
          # Get symbols from input, or from secret, or default to SPY
          SYMBOLS_INPUT: ${{ github.event.inputs.symbols }}
          SYMBOLS_SECRET: ${{ secrets.TRADING_SYMBOLS }}
        run: |
          echo "ğŸš€ Triggering auto trade at $(date)"
          echo "App URL: $APP_URL"
          
          if [ -z "$APP_URL" ]; then
            echo "âŒ APP_URL secret is not set. Please add it in GitHub Secrets."
            exit 1
          fi
          
          # Determine which symbols to trade
          if [ -n "$SYMBOLS_INPUT" ]; then
            SYMBOLS="$SYMBOLS_INPUT"
            echo "ğŸ“Š Using symbols from workflow input: $SYMBOLS"
          elif [ -n "$SYMBOLS_SECRET" ]; then
            SYMBOLS="$SYMBOLS_SECRET"
            echo "ğŸ“Š Using symbols from TRADING_SYMBOLS secret: $SYMBOLS"
          else
            SYMBOLS="SPY"
            echo "ğŸ“Š No symbols configured, using default: $SYMBOLS"
            echo "â„¹ï¸  Tip: Set TRADING_SYMBOLS secret (comma-separated) to trade multiple symbols automatically"
          fi
          
          if [ -z "$API_SECRET" ]; then
            echo "âš ï¸ AUTO_TRADE_SECRET not set. Endpoint may require authentication."
          fi
          
          # Convert comma-separated string to array and loop through symbols
          IFS=',' read -ra SYMBOL_ARRAY <<< "$SYMBOLS"
          total_symbols=${#SYMBOL_ARRAY[@]}
          success_count=0
          fail_count=0
          
          echo "ğŸ“ˆ Trading $total_symbols symbol(s): ${SYMBOL_ARRAY[*]}"
          echo ""
          
          for symbol in "${SYMBOL_ARRAY[@]}"; do
            # Trim whitespace
            symbol=$(echo "$symbol" | xargs)
            
            if [ -z "$symbol" ]; then
              continue
            fi
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“Š Processing symbol: $symbol"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Make the request to your API endpoint (with -L to follow redirects)
            if [ -z "$API_SECRET" ]; then
              response=$(curl -s -L -w "\n%{http_code}" -X POST "$APP_URL/api/strategy/auto" \
                -H "Content-Type: application/json" \
                -d "{\"symbol\": \"$symbol\", \"autoExecute\": true}")
            else
              response=$(curl -s -L -w "\n%{http_code}" -X POST "$APP_URL/api/strategy/auto" \
                -H "Content-Type: application/json" \
                -H "x-api-secret: $API_SECRET" \
                -d "{\"symbol\": \"$symbol\", \"autoExecute\": true}")
            fi
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')
            
            echo "Response code: $http_code"
            echo "Response body:"
            echo "$body" | jq '.' 2>/dev/null || echo "$body"
            
            if [ "$http_code" -eq 401 ]; then
              echo "âŒ Unauthorized. Check that AUTO_TRADE_SECRET matches your server's AUTO_TRADE_SECRET env var."
              ((fail_count++))
              continue
            elif [ "$http_code" -ne 200 ]; then
              echo "âŒ Request failed with status $http_code for $symbol"
              ((fail_count++))
              continue
            fi
            
            # Check if the response indicates success
            success=$(echo "$body" | grep -o '"success":[^,}]*' | grep -o 'true\|false' | head -1)
            skipped=$(echo "$body" | grep -o '"skipped":[^,}]*' | grep -o 'true\|false' | head -1)
            
            if [ "$skipped" = "true" ]; then
              echo "â„¹ï¸ Trade skipped for $symbol (likely market is closed)"
            elif [ "$success" != "true" ]; then
              echo "âš ï¸ Trade may have failed or been skipped for $symbol"
              ((fail_count++))
            else
              echo "âœ… Auto trade completed successfully for $symbol"
              executed=$(echo "$body" | grep -o '"executed":[^,}]*' | grep -o 'true\|false' | head -1)
              if [ "$executed" = "true" ]; then
                echo "âœ… Trade was executed for $symbol"
                ((success_count++))
              else
                echo "â„¹ï¸ Signal generated but trade not executed for $symbol (likely HOLD signal or already have position)"
                ((success_count++))
              fi
            fi
            
            echo ""
            # Small delay between symbols to avoid rate limits
            sleep 2
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Summary:"
          echo "   Total symbols: $total_symbols"
          echo "   Successful: $success_count"
          echo "   Failed: $fail_count"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ $fail_count -gt 0 ]; then
            echo "âš ï¸ Some trades failed"
            exit 1
          fi

